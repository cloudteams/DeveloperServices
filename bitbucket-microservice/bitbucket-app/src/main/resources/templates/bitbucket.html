<div th:fragment="bitbucket-authentication">
    <head>
        <title>Authorize Bitbucket &mdash; CLOUDTEAMS</title>

        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <link href="http://cdn.jsdelivr.net/webjars/bootstrap/3.3.5/css/bootstrap.min.css"
              th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}"
              rel="stylesheet" media="screen"/>
        <link rel="stylesheet" href="/bitbucket/css/dashboard.css" th:href="@{/bitbucket/css/dashboard.css}"/>
    </head>
    <body>

        <div class="container">
            <img class="bitbucket" src="/bitbucket/images/cloudteams-logo.png"/>
            <div class="alert alert-warning">Successfully authorized with Bitbucket.</div>

            <button type="button" onclick="window.close();" class="btn btn-danger">
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Close window
            </button>
        </div>

        <script src="http://cdn.jsdelivr.net/webjars/jquery/2.1.4/jquery.min.js"
        th:src="@{/webjars/jquery/2.1.4/jquery.min.js}"></script>

    </body>

</div>

<div th:fragment="bitbucket-no-auth">

    <div class="alert alert-warning">Please synchronize your Bitbucket account</div>
    <button id="btn-oauth" onclick="authorizeBitbucket()" class="btn btn-danger">Synchronize Bitbucket</button>
    <br/>

    <script th:inline="javascript">

        //Check if an outdated token exists then removed
        if (hasBitbucketAccessToken()) {
            localStorage.removeItem("bitbucket_auth_token");
        }

        var BITBUCKET_AUTHORIZE_URL = "https://bitbucket.org/site/oauth2/authorize?response_type=code&amp;client_id=6xQqvPuY6ZgFcsGmDj&amp;redirect_uri=https://cloudteams.euprojects.net/bitbucket/api/v1/bitbucket/auth?username=" + ct_user_name+ "&amp;scope=account";

    var POPUP;

        function authorizeBitbucket() {
            POPUP = window.open(BITBUCKET_AUTHORIZE_URL, "mywindow", "status=0,toolbar=0,resizable=0,scrollbars=0,width=1020,height=618");

            $.post({
                data: {username: ct_user_name},
                url: CLOUDTEAMS_BITBUCKET_REST_ENDPOINT + "/auth/token"
            }).success(function (data, status, xhr) {
                var res = JSON.parse(data);
                if ("SUCCESS" === res.code) {
                    localStorage.bitbucket_auth_token = res.token;
                    loadBitbucketWidget()();
                }
                console.log(res.message);
            });
        }

    </script>
</div>

<div th:fragment="bitbucket-no-project">
    <div class="alert alert-warning">Please select a Bitbucket repository</div>
    <select id="repository" th:if="${!GetRepositories.getValues().isEmpty()}">
        <option th:each="repo : ${GetRepositories.getValues()}" th:value="${repo.getSlug()}" th:text="${repo.getName()}"></option>
    </select>
    <br/><br/>
    <button id="btn-oauth" onclick="assignRepository()" class="btn btn-danger">Assign Repository</button>

    <script th:inline="javascript">

        function assignRepository() {

            $.post({
                url: CLOUDTEAMS_BITBUCKET_REST_ENDPOINT + "/bitbucket/add",
                data: {project_id: ct_project_id, reponame: $("#repository").val()},
                beforeSend: function (xhr) {
                    if (hasBitbucketAccessToken()) {
                        xhr.setRequestHeader("Authorization", localStorage.bitbucket_auth_token);
                    }
                },
            }).success(function (data, status, xhr) {

                var res = JSON.parse(data);
                if ("SUCCESS" === res.code) {
                    //Reload Github widget
                    loadBitbucketWidget();
                }
                console.log(res.message);
            });
        }

    </script>
</div>


<div th:fragment="bitbucket-auth-project">

    <div class="alert alert-warning">Bitbucket Statistics</div>

    <p th:inline="text"><a th:href="'https://bitbucket.com/' + ${bitbucketStats.getRepository().getOwner().getUsername()}">[[${bitbucketStats.getRepository().getOwner().getUsername()}]]</a>/<a th:href="'https://bitbucket.com/' + ${bitbucketStats.getRepository().getFullName()}">[[${bitbucketStats.getRepository().getName()}]]</a></p>
    <p th:inline="text">[[${bitbucketStats.getRepository().getDescription()}]]</p>

    <!--Last Update-->
    <p class="bold" th:inline="text">
        <span class="highlight">Last Update (<span th:text="${#strings.substring(bitbucketStats.getRepository().getUpdatedOn(),0,9)}"></span>)</span>
    </p>

    <hr/>

        <!-- 1. Code Section (commitsTotal,branchesNames,releasesNames,contibutorsTotal,repositoryName(withUrl) )-->
    <h3 class="header-medium secondary">Code</h3>

    <div class="data">
<!--        Commits
        <p class="bold" th:inline="text">
            <span class="highlight">Commits (<span th:text="${bitbucketStats.getCommits().size()}"></span>) </span>
            <a th:href="${bitbucketStats.getRepository().getHtmlUrl()} + '/commits/master'"><i class="icon icon-object"></i></a>
        </p>

        Contributors
        <p class="bold" th:inline="text">
            <span class="highlight">Contributors (<span th:text="${bitbucketStats.getCollaborators().size()}"></span>)</span>
            <a th:href="${bitbucketStats.getRepository().getHtmlUrl()} + '/graphs/contributors'"><i class="icon icon-object"></i></a>
        </p>

        Watchers
        <p class="bold" th:inline="text">
            <span class="highlight">Watchers (<span th:text="${bitbucketStats.getRepository().getWatchers()}"></span>)</span>
            <a th:href="${bitbucketStats.getRepository().getHtmlUrl()} + '/watchers'"><i class="icon icon-object"></i></a>
        </p>

        Forks
        <p class="bold" th:inline="text">
            <span class="highlight">Forks (<span th:text="${bitbucketStats.getRepository().getForks()}"></span>)</span>
        </p>-->

        Branches
        <p class="bold" th:inline="text">
            <span class="highlight">Branches (<span th:text="${bitbucketStats.getBranches().getValues().size()}"></span>)</span>
            <a target="_blank" th:each="branch : ${bitbucketStats.getBranches().getValues()}" th:href="${ 'https://bitbucket.com/' +  bitbucketStats.getRepository().getFullname() + '/tree/' + branch.getName()}" th:text="${branch.getName()}"></a>
        </p>
    </div>

    <hr/>
<!--
     2. Issues Section (openissuesTotal,closedisseusTotal,labelNames,milestonesNames) 
    <h3 class="header-medium secondary">Issues</h3>

    Open Issues
    <p class="bold" th:inline="text">
        <span class="highlight">Open Issues (<span th:text="${bitbucketStats.getRepository().getOpenIssues()}"></span>)</span>
        <a th:href="${bitbucketStats.getRepository().getHtmlUrl()} + '/issues'"><i class="icon icon-object"></i></a>
    </p>

    Closed Issues
    <p class="bold" th:inline="text">
        <span class="highlight">Closed Issues </span>
        <a th:href="${bitbucketStats.getRepository().getHtmlUrl()} + '/issues?q=is%3Aissue+is%3Aclosed'"><i class="icon icon-object"></i></a>
    </p>

    Labels
    <p class="bold" th:inline="text">
        <span class="highlight">Labels </span>
        <a target="_blank" th:each="label : ${bitbucketStats.getLabels()}" th:href="${bitbucketStats.getRepository().getHtmlUrl() + '/labels/' + label.getName()}" th:text="${label.getName()}"></a>
    </p>

    <hr/>

     3. Pulse (weekly authors/commits(master), file changes master, additions /deletions master)  
    <h3 class="header-medium secondary">Pulse</h3>

    Last Weeks Stats
    <p class="bold" th:inline="text">
        Excluding merges, <span class="highlight" th:text="${bitbucketStats.getCommitsStats().getContributors()}"></span> authors have pushed <span class="highlight" th:text="${bitbucketStats.getCommitsStats().getTotalCommits()}"></span> commits to all branches. On master, <span class="highlight" th:text="${bitbucketStats.getCommitsStats().getTotalChanges()}"></span>      files have changed and there have been <span class="highlight" th:text="${bitbucketStats.getCommitsStats().getTotalAdditions()}"></span> additions and <span class="highlight" th:text="${bitbucketStats.getCommitsStats().getTotalDeletions()}"></span> deletions.
    </p>-->

    <button id="btn-unassign" onclick="unassignRepository()" class="btn btn-danger">Unassign</button>

    <script th:inline="javascript">

        function unassignRepository() {

            $.post({
                url: CLOUDTEAMS_BITBUCKET_REST_ENDPOINT + "/bitbucket/delete",
                data: {project_id: ct_project_id},
                beforeSend: function (xhr) {
                    if (hasGithubAccessToken()) {
                        xhr.setRequestHeader("Authorization", localStorage.bitbucket_auth_token);
                    }
                },
            }).success(function (data, status, xhr) {

                var res = JSON.parse(data);
                if ("SUCCESS" === res.code) {
                    //Reload Github widget
                    loadBitbucketWidget()();
                }
                console.log(res.message);
            });

        }

    </script>

</div>

<div th:fragment="bitbucket-error">
    <img id="error_image" width="200px" src="data:image/png;base64,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"  />
    <div class="alert alert-danger" >
        <strong>ERROR!!!</strong>
        <br/>
        <span>Page request does not completed that's all we know.<br /></span>
    </div>
</div>